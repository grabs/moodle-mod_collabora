define("mod_collabora/postmessage",["exports","jquery","core/fragment","core/templates","core/ajax","core/notification","core/log"],(function(_exports,_jquery,_fragment,_templates,_ajax,_notification,_log){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Closes the collabora window.
   *
   * @module     mod_collabora/monitorclose
   * @author     Andreas Grabs <moodle@grabs-edv.de>
   * @copyright  2019 Humboldt-Universit√§t zu Berlin <moodle-support@cms.hu-berlin.de>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_fragment=_interopRequireDefault(_fragment),_templates=_interopRequireDefault(_templates),_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log);_exports.init=opts=>{var courseURL,collaboraUrl,destinationOrigin,asPopup,iframeid,versionviewer,id,contextid,version,strBack,imgBackUrl,uiMode,newVersion,versionManager;function showVersionView(){var serviceparams={function:"version_viewer_content",id:id,version:version};_fragment.default.loadFragment("mod_collabora","get_html",contextid,serviceparams).then((function(html,js){(0,_jquery.default)("#"+versionviewer.id).collapse("show"),document.querySelector("#"+versionviewer.id+" .card-body").innerHTML=html,js&&_templates.default.runTemplateJS(js)})).fail(_notification.default.exception)}function postMessage(postObject){postObject.SendTime=Date.now();var message=JSON.stringify(postObject);_log.default.debug("Post message to collabora: "+message);var iframe=document.getElementById(iframeid);(iframe=iframe.contentWindow||iframe.contentDocument.document||iframe.contentDocument).postMessage(message,destinationOrigin)}function setFrameData(){_log.default.debug("Set iframe source: "+collaboraUrl);var serviceparams={function:"wopi_src",id:id,version:version};_fragment.default.loadFragment("mod_collabora","get_html",contextid,serviceparams).then((function(strparams){var params=JSON.parse(strparams),form=document.createElement("form");form.method="get",form.action=collaboraUrl,form.target=iframeid;for(const[key,value]of Object.entries(params)){var element=document.createElement("input");element.type="hidden",element.name=key,element.value=value,form.appendChild(element),_log.default.debug("Add element "+key+": "+value)}document.body.appendChild(form),form.submit()})).fail(_notification.default.exception)}courseURL=opts.courseurl,collaboraUrl=opts.collaboraurl,destinationOrigin=opts.destinationorigin,asPopup=opts.aspopup,iframeid=opts.iframeid,id=opts.id,contextid=opts.contextid,strBack=opts.strback,imgBackUrl=opts.imgbackurl,uiMode=opts.uimode,versionManager=opts.versionmanager,version=0,newVersion=0,setFrameData(),function(){const inlineelement=document.querySelector("#collabora-inline_"+id),modalelement=document.querySelector("#collaboramodal-body_"+id),iframecontainer=document.querySelector("#iframe-container_"+id);(0,_jquery.default)("#collaboramodal_"+id).on("show.bs.modal",(function(){modalelement.append(iframecontainer),(0,_jquery.default)("body").addClass("modal-open"),setFrameData()})),(0,_jquery.default)("#collaboramodal_"+id).on("hide.bs.modal",(function(){inlineelement.append(iframecontainer),(0,_jquery.default)("body").removeClass("modal-open"),setFrameData()}))}(),versionviewer=document.getElementById(opts.versionviewerid),window.addEventListener("message",(function(event){var msg;if(_log.default.debug("ReceiveMessage from "+event.origin+": "+event.data),"string"!=typeof event.data&&!(event.data instanceof String))return;if(!(msg=JSON.parse(event.data)))return;switch(msg.MessageId){case"UI_Close":asPopup?window.close():window.location.href=courseURL;break;case"App_LoadingStatus":!function(msg){if(msg.Values&&"Document_Loaded"==msg.Values.Status){if(postMessage({MessageId:"Host_PostmessageReady"}),0!=newVersion)return void postMessage({MessageId:"Host_VersionRestore",Values:{Status:"Pre_Restore"}});postMessage({MessageId:"Disable_Default_UIAction",Values:{action:"UI_Save",disable:!0}}),postMessage({MessageId:"Action_ChangeUIMode",Values:{Mode:uiMode}}),version>0&&postMessage({MessageId:"Insert_Button",Values:{id:"moodle_go_back",imgurl:imgBackUrl,label:strBack,hint:strBack}})}}(msg);break;case"UI_FileVersions":showVersionView();break;case"UI_Save":postMessage({MessageId:"Action_Save",Values:{DontTerminateEdit:!0,DontSaveIfUnmodified:!0}});break;case"Clicked_Button":!function(msg){msg.Values&&"moodle_go_back"==msg.Values.Id&&(version=0,setFrameData())}(msg);break;case"App_VersionRestore":!function(msg){if(!versionManager)return;if("Pre_Restore_Ack"==msg.Values.Status){_ajax.default.call([{methodname:"mod_collabora_restore_version",args:{id:id,version:newVersion}}])[0].done((function(data){1==data.success?(version=0,newVersion=0,setFrameData(),showVersionView()):_notification.default.exception({message:data.failuremsg})})).fail(_notification.default.exception)}}(msg);break;case"SET_VERSION":version=msg.Values.version,setFrameData(),showVersionView();break;case"RESTORE_VERSION":theNewVersion=msg.Values.version,version=0,newVersion=theNewVersion,setFrameData()}var theNewVersion}))}}));

//# sourceMappingURL=postmessage.min.js.map