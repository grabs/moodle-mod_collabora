{"version":3,"file":"postmessage.min.js","sources":["../src/postmessage.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Closes the collabora window.\n *\n * @module     mod_collabora/monitorclose\n * @author     Andreas Grabs <moodle@grabs-edv.de>\n * @copyright  2019 Humboldt-Universit√§t zu Berlin <moodle-support@cms.hu-berlin.de>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([], function() {\n    var collaboraUrl;\n    var courseURL;\n    var asPopup;\n    var iframe;\n\n    /**\n     * Listener function for the event 'message'\n     * @param {Event} event\n     */\n    function receiveMessage(event) {\n        var msg, msgId;\n\n        console.log('ReceiveMessage: ' + event.data);\n\n        msg = JSON.parse(event.data);\n        if (!msg) {\n            return;\n        }\n\n        msgId = msg.MessageId;\n\n        switch (msgId) {\n            case 'UI_Close':\n                closeDoc();\n                break;\n            case 'App_LoadingStatus':\n                tellLoadingStatus(msg);\n                break;\n        }\n    }\n\n    function closeDoc() {\n        if (asPopup) {\n            window.close();\n        } else {\n            window.location.href = courseURL;\n        }\n    }\n\n    function tellLoadingStatus(msg) {\n        if (msg.Values) {\n            if (msg.Values.Status == 'Document_Loaded') {\n                console.log('Tell the wopi client that we are ready to receive messages');\n                // Send the Host_PostMessageReady  before other posts (Mandatory)\n                var postObject = {\n                    'MessageId': 'Host_PostmessageReady',\n                    'SendTime': Date.now()\n                };\n                postMessage(postObject);\n            }\n        }\n    }\n\n    function postMessage(postObject) {\n        var message = JSON.stringify(postObject);\n        console.log('Post message to collabora: ' + message);\n        iframe.postMessage(message, collaboraUrl);\n    }\n\n    return {\n        init: function(opts) {\n            collaboraUrl = opts.collaboraurl;\n            courseURL = opts.courseurl;\n            asPopup = opts.aspopup;\n            iframe = document.getElementById(opts.iframeid);\n            iframe = iframe.contentWindow || (iframe.contentDocument.document || iframe.contentDocument);\n            window.addEventListener('message', receiveMessage);\n        }\n    };\n});"],"names":["define","collaboraUrl","courseURL","asPopup","iframe","receiveMessage","event","msg","console","log","data","JSON","parse","MessageId","window","close","location","href","Values","Status","postObject","message","stringify","postMessage","Date","now","tellLoadingStatus","init","opts","collaboraurl","courseurl","aspopup","document","getElementById","iframeid","contentWindow","contentDocument","addEventListener"],"mappings":";;;;;;;;AAuBAA,mCAAO,IAAI,eACHC,aACAC,UACAC,QACAC,gBAMKC,eAAeC,WAChBC,OAEJC,QAAQC,IAAI,mBAAqBH,MAAMI,MAEvCH,IAAMI,KAAKC,MAAMN,MAAMI,aAKfH,IAAIM,eAGH,WAULV,QACAW,OAAOC,QAEPD,OAAOE,SAASC,KAAOf,oBAVlB,8BAccK,QACnBA,IAAIW,OAAQ,IACa,mBAArBX,IAAIW,OAAOC,OACXX,QAAQC,IAAI,uEAWHW,gBACbC,QAAUV,KAAKW,UAAUF,YAC7BZ,QAAQC,IAAI,8BAAgCY,SAC5CjB,OAAOmB,YAAYF,QAASpB,cARpBsB,CAJiB,WACA,iCACDC,KAAKC,SApBrBC,CAAkBnB,YAiCvB,CACHoB,KAAM,SAASC,MACX3B,aAAe2B,KAAKC,aACpB3B,UAAY0B,KAAKE,UACjB3B,QAAUyB,KAAKG,QAEf3B,QADAA,OAAS4B,SAASC,eAAeL,KAAKM,WACtBC,eAAkB/B,OAAOgC,gBAAgBJ,UAAY5B,OAAOgC,gBAC5EtB,OAAOuB,iBAAiB,UAAWhC"}